# ì‹œìŠ¤í…œ íë¦„ ë¶„ì„ ë° ê°œì„  ê³„íš

## ğŸ“‹ ì‚¬ìš©ì ìš”êµ¬ì‚¬í•­ íë¦„ ì •ë¦¬

### ì „ì²´ íŒŒì´í”„ë¼ì¸

```
1. ì›Œì¹˜ â†’ íŒŒì´ì–´ìŠ¤í† ì–´ (ì™„ë£Œ)
   â†“
2. raw_periodic (node.js) + raw_events (ML â†’ node.js)
   â†“
3. ë‚ ì”¨/ê³„ì ˆ/ì˜¨ë„ ì •ë³´ (node.js)
   â†“
4. ì „ì²˜ë¦¬/ë§ˆë¥´ì½”í”„ (ìˆ˜ì¹˜í˜• ë°ì´í„° ê°€ê³µ)
   â†“
5. LLMì— ì „ì†¡ (ì‚¬ìš©ì ì„ í˜¸ë„ í¬í•¨)
   â†“
6. JSON ìŠ¤í‚¤ë§ˆë¡œ ê°•ì œ ì‘ë‹µ
   â†“
7. í”„ë¡¬í”„íŠ¸ ì£¼ì… ë° ì›ì¹™ ì„¤ì •
   â†“
8. 1ê°œ ë¬´ë“œìŠ¤íŠ¸ë¦¼ (10ê°œ ì„¸ê·¸ë¨¼íŠ¸) ìƒì„±
   â†“
9. home/page.tsxì—ì„œ ê´€ë¦¬
   â†’ device card, mooddashboard, ë¼ì¦ˆë² ë¦¬íŒŒì´ë¡œ ì „ì†¡
   â†“
10. ë””ë°”ì´ìŠ¤ ì¹´ë“œ í™•ì¥ â†’ ì¼ë¶€ ì •ë³´ ë³€ê²½ (ì¦‰ê° ë°˜ì˜)
   â†“
11. ë³„í‘œ í´ë¦­ â†’ í˜„ì¬ ì„¸íŒ…ê°’ì„ moodì— ì €ì¥
   â†“
12. ë¡œê·¸ì¸ í›„ ìµœì´ˆ home ì§„ì… ì‹œ ìë™ ìƒì„± ì‹œì‘
   â†“
13. ì´ˆê¸° 3ì„¸ê·¸ë¨¼íŠ¸ ì œê³µ (í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì»¨ì…‰)
   â†“
14. 3ì„¸ê·¸ë¨¼íŠ¸ ì§„í–‰ ì¤‘ LLMìœ¼ë¡œ ë¬´ë“œìŠ¤íŠ¸ë¦¼ ìƒì„±
   â†“
15. ì´ˆê¸° 7ê°œ ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ë¹„í™œì„±í™”ëœ ì˜ì—­ì— ì—°ê²°, ë§ˆì§€ë§‰ 3ê°œëŠ” ë²„ë¦¼
   â†“
16. í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ê°€ ë’¤ì—ì„œ 2ë²ˆì§¸ ì´ë‚´ì¼ ë•Œ ë‹¤ìŒ ìŠ¤íŠ¸ë¦¼ ìƒì„± ì‹œë„
   â†“
17. ë””ë°”ì´ìŠ¤ ì¹´ë“œ ë³€ê²½ â†’ ìŒëŸ‰ ì¦‰ê° ë°˜ì˜, ë¹›/ì»¬ëŸ¬ëŠ” route.tsë¡œ ì „ì†¡
   â†“
18. ë¼ì¦ˆë² ë¦¬íŒŒì´ê°€ í’€ë§ìœ¼ë¡œ ê°€ì ¸ê° (0.5ì´ˆë§ˆë‹¤)
   â†“
19. ì„¸ê·¸ë¨¼íŠ¸ ì „í™˜ ì‹œ ì¦‰ê°ì ìœ¼ë¡œ UI ë°˜ì˜
```

---

## ğŸ” í˜„ì¬ ì½”ë“œë² ì´ìŠ¤ ë¶„ì„

### âœ… ì˜ êµ¬í˜„ëœ ë¶€ë¶„

1. **ì´ˆê¸° 3ì„¸ê·¸ë¨¼íŠ¸ ìƒì„±** âœ…
   - `src/lib/mock/getInitialColdStartSegments.ts`ì—ì„œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì»¨ì…‰ 3ì„¸ê·¸ë¨¼íŠ¸ ìƒì„±
   - DBì—ì„œ ì‹¤ì œ ìºë¡¤ ìŒì•… ê°€ì ¸ì˜¤ê¸°
   - Fallback ì„¸ê·¸ë¨¼íŠ¸ ì œê³µ

2. **ë¬´ë“œìŠ¤íŠ¸ë¦¼ ìƒì„± API** âœ…
   - `src/app/api/moods/current/generate/route.ts`
   - ì „ì²˜ë¦¬ + ë§ˆë¥´ì½”í”„ + LLM í˜¸ì¶œ
   - 10ê°œ ì„¸ê·¸ë¨¼íŠ¸ ìƒì„± í›„ 7ê°œë§Œ ë°˜í™˜

3. **ë¼ì¦ˆë² ë¦¬íŒŒì´ í†µì‹  API** âœ…
   - `src/app/api/light_info/route.ts`
   - `src/app/api/light_power/route.ts`
   - `src/app/api/search_light/route.ts`
   - GETìœ¼ë¡œ í’€ë§ ê°€ëŠ¥í•œ êµ¬ì¡°

4. **ë¬´ë“œ ì €ì¥** âœ…
   - `src/app/api/moods/saved/route.ts` (POST)
   - ë³„í‘œ í´ë¦­ ì‹œ í˜„ì¬ ì„¸íŒ…ê°’ ì €ì¥

5. **ë””ë°”ì´ìŠ¤ ì„¤ì • ì—…ë°ì´íŠ¸** âœ…
   - `src/app/api/devices/[deviceId]/update/route.ts`
   - `src/app/api/devices/[deviceId]/power/route.ts`

---

## âš ï¸ ë¬¸ì œì  ë° ë³µì¡í•œ ë¶€ë¶„

### 1. ì„¸ê·¸ë¨¼íŠ¸ ì „í™˜ ë¡œì§ì˜ ë³µì¡ì„±

**í˜„ì¬ ë¬¸ì œ**:
- `home/page.tsx`ì— ì„¸ê·¸ë¨¼íŠ¸ ì „í™˜, ìŠ¤íŠ¸ë¦¼ ìƒì„±, ì´ˆê¸° ì„¸ê·¸ë¨¼íŠ¸ ì²˜ë¦¬ ë¡œì§ì´ ëª¨ë‘ ì„ì—¬ ìˆìŒ
- ì´ˆê¸° 3ì„¸ê·¸ë¨¼íŠ¸ì™€ LLM ìƒì„± ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ë³‘í•©í•˜ëŠ” ë¡œì§ì´ ë³µì¡í•¨
- "ë’¤ì—ì„œ 2ë²ˆì§¸ ì´ë‚´" ì²´í¬ ë¡œì§ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ

**ê°œì„  ë°©ì•ˆ**:
- ì„¸ê·¸ë¨¼íŠ¸ ê´€ë¦¬ ì „ìš© í›… ìƒì„± (`useMoodStreamManager`)
- ì´ˆê¸° ì„¸ê·¸ë¨¼íŠ¸ì™€ LLM ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© ë¡œì§ ë¶„ë¦¬
- ì„¸ê·¸ë¨¼íŠ¸ ì „í™˜ ì¡°ê±´ ëª…í™•í™”

### 2. ë””ë°”ì´ìŠ¤ ì¹´ë“œ ë³€ê²½ ì¦‰ê° ë°˜ì˜

**í˜„ì¬ ë¬¸ì œ**:
- ìŒëŸ‰ ë³€ê²½ê³¼ ë¹›/ì»¬ëŸ¬ ë³€ê²½ì˜ ì²˜ë¦¬ ë°©ì‹ì´ ë‹¤ë¦„
- ì¦‰ê° ë°˜ì˜ vs route.ts ì „ì†¡ì˜ êµ¬ë¶„ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ
- ìƒíƒœ ë™ê¸°í™”ê°€ ë³µì¡í•¨

**ê°œì„  ë°©ì•ˆ**:
- ë””ë°”ì´ìŠ¤ ìƒíƒœ ë³€ê²½ ì „ìš© í›… ìƒì„± (`useDeviceState`)
- ë³€ê²½ íƒ€ì…ë³„ ì²˜ë¦¬ ë¡œì§ ëª…í™•í™”
- ìƒíƒœ ë™ê¸°í™” ë‹¨ìˆœí™”

### 3. ë¬´ë“œìŠ¤íŠ¸ë¦¼ ìë™ ìƒì„± ì‹œì 

**í˜„ì¬ ë¬¸ì œ**:
- ë¡œê·¸ì¸ í›„ ìµœì´ˆ home ì§„ì… ì‹œ ìë™ ìƒì„± ë¡œì§ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ
- "ë’¤ì—ì„œ 2ë²ˆì§¸ ì´ë‚´" ì²´í¬ê°€ ì–´ë””ì„œ ì´ë£¨ì–´ì§€ëŠ”ì§€ ë¶ˆëª…í™•
- ì´ˆê¸° 3ì„¸ê·¸ë¨¼íŠ¸ì™€ LLM ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© íƒ€ì´ë°ì´ ë³µì¡í•¨

**ê°œì„  ë°©ì•ˆ**:
- ìë™ ìƒì„± ì¡°ê±´ì„ ëª…í™•í•œ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
- ì„¸ê·¸ë¨¼íŠ¸ ì¸ë±ìŠ¤ ê¸°ë°˜ ì²´í¬ ë¡œì§ ë‹¨ìˆœí™”
- ì´ˆê¸° ì„¸ê·¸ë¨¼íŠ¸ì™€ LLM ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© ì „ëµ ëª…í™•í™”

### 4. ìƒíƒœ ê´€ë¦¬ì˜ ë¶„ì‚°

**í˜„ì¬ ë¬¸ì œ**:
- `home/page.tsx`ì— ë„ˆë¬´ ë§ì€ ìƒíƒœì™€ ë¡œì§ì´ ì§‘ì¤‘
- ì„¸ê·¸ë¨¼íŠ¸, ë””ë°”ì´ìŠ¤, ë¬´ë“œ ìƒíƒœê°€ ì„œë¡œ ì–½í˜€ ìˆìŒ
- ë²„ê·¸ ìˆ˜ì •ìœ¼ë¡œ ì¸í•´ ì¡°ê±´ë¬¸ì´ ì¤‘ì²©ë˜ì–´ ë³µì¡í•¨

**ê°œì„  ë°©ì•ˆ**:
- ìƒíƒœ ê´€ë¦¬ë¥¼ ì—¬ëŸ¬ í›…ìœ¼ë¡œ ë¶„ë¦¬
- ê° í›…ì˜ ì±…ì„ ëª…í™•í™”
- ìƒíƒœ ê°„ ì˜ì¡´ì„± ìµœì†Œí™”

---

## ğŸ¯ ê°œì„  ìš°ì„ ìˆœìœ„

### ğŸ”´ ë†’ìŒ (ì¦‰ì‹œ ê°œì„  í•„ìš”)

1. **ì„¸ê·¸ë¨¼íŠ¸ ê´€ë¦¬ ë¡œì§ ë‹¨ìˆœí™”**
   - `useMoodStreamManager` í›… ìƒì„±
   - ì´ˆê¸° ì„¸ê·¸ë¨¼íŠ¸ì™€ LLM ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© ë¡œì§ ë¶„ë¦¬
   - ì„¸ê·¸ë¨¼íŠ¸ ì „í™˜ ì¡°ê±´ ëª…í™•í™”

2. **ë””ë°”ì´ìŠ¤ ìƒíƒœ ë³€ê²½ ë¡œì§ ì •ë¦¬**
   - `useDeviceState` í›… ìƒì„±
   - ì¦‰ê° ë°˜ì˜ vs route.ts ì „ì†¡ êµ¬ë¶„ ëª…í™•í™”
   - ìƒíƒœ ë™ê¸°í™” ë‹¨ìˆœí™”

### ğŸŸ¡ ì¤‘ê°„ (ë‹¨ê³„ì  ê°œì„ )

3. **ë¬´ë“œìŠ¤íŠ¸ë¦¼ ìë™ ìƒì„± ë¡œì§ ê°œì„ **
   - ìë™ ìƒì„± ì¡°ê±´ í•¨ìˆ˜í™”
   - "ë’¤ì—ì„œ 2ë²ˆì§¸ ì´ë‚´" ì²´í¬ ë¡œì§ ëª…í™•í™”
   - ì´ˆê¸° ì„¸ê·¸ë¨¼íŠ¸ì™€ LLM ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© ì „ëµ ê°œì„ 

4. **ìƒíƒœ ê´€ë¦¬ ë¶„ë¦¬**
   - `home/page.tsx`ì˜ ë³µì¡ë„ ê°ì†Œ
   - ê° í›…ì˜ ì±…ì„ ëª…í™•í™”
   - ìƒíƒœ ê°„ ì˜ì¡´ì„± ìµœì†Œí™”

### ğŸŸ¢ ë‚®ìŒ (ì„ íƒì  ê°œì„ )

5. **ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ **
   - ì„¸ê·¸ë¨¼íŠ¸ ìƒì„± ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
   - ë””ë°”ì´ìŠ¤ ìƒíƒœ ë™ê¸°í™” ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬

6. **ì„±ëŠ¥ ìµœì í™”**
   - ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
   - ì„¸ê·¸ë¨¼íŠ¸ ì „í™˜ ì‹œ ìµœì í™”

---

## ğŸ“ êµ¬ì²´ì  ê°œì„  ê³„íš

### Phase 1: ì„¸ê·¸ë¨¼íŠ¸ ê´€ë¦¬ ë¡œì§ ë‹¨ìˆœí™”

**ëª©í‘œ**: ì´ˆê¸° ì„¸ê·¸ë¨¼íŠ¸ì™€ LLM ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© ë¡œì§ì„ ëª…í™•í•˜ê³  ë‹¨ìˆœí•˜ê²Œ ë§Œë“¤ê¸°

**ì‘ì—…**:
1. `useMoodStreamManager` í›… ìƒì„±
   - ì´ˆê¸° ì„¸ê·¸ë¨¼íŠ¸ ë¡œë“œ
   - LLM ì„¸ê·¸ë¨¼íŠ¸ ìƒì„± ë° ë³‘í•©
   - ì„¸ê·¸ë¨¼íŠ¸ ì „í™˜ ê´€ë¦¬
   - ë‹¤ìŒ ìŠ¤íŠ¸ë¦¼ ìƒì„± ì¡°ê±´ ì²´í¬

2. ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© ì „ëµ ëª…í™•í™”
   ```typescript
   // ì´ˆê¸° 3ì„¸ê·¸ë¨¼íŠ¸: [0, 1, 2]
   // LLM ìƒì„± 7ì„¸ê·¸ë¨¼íŠ¸: [3, 4, 5, 6, 7, 8, 9]
   // ë§ˆì§€ë§‰ 3ì„¸ê·¸ë¨¼íŠ¸ ë²„ë¦¼: [7, 8, 9] ì œê±°
   // ìµœì¢…: [0, 1, 2, 3, 4, 5, 6] (ì´ˆê¸° 3ê°œ + LLM 4ê°œ)
   ```

3. ì„¸ê·¸ë¨¼íŠ¸ ì „í™˜ ì¡°ê±´ ëª…í™•í™”
   ```typescript
   // í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ ì¸ë±ìŠ¤ê°€ (ì „ì²´ ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜ - 2) ì´ìƒì¼ ë•Œ
   // ì˜ˆ: 10ê°œ ì„¸ê·¸ë¨¼íŠ¸ ì¤‘ 8ë²ˆì§¸ ì´ìƒì¼ ë•Œ ë‹¤ìŒ ìŠ¤íŠ¸ë¦¼ ìƒì„±
   ```

### Phase 2: ë””ë°”ì´ìŠ¤ ìƒíƒœ ë³€ê²½ ë¡œì§ ì •ë¦¬

**ëª©í‘œ**: ë””ë°”ì´ìŠ¤ ì¹´ë“œ ë³€ê²½ ì‹œ ì¦‰ê° ë°˜ì˜ê³¼ route.ts ì „ì†¡ì„ ëª…í™•íˆ êµ¬ë¶„

**ì‘ì—…**:
1. `useDeviceState` í›… ìƒì„±
   - ë””ë°”ì´ìŠ¤ ìƒíƒœ ê´€ë¦¬
   - ë³€ê²½ íƒ€ì…ë³„ ì²˜ë¦¬ (ìŒëŸ‰: ì¦‰ê° ë°˜ì˜, ë¹›/ì»¬ëŸ¬: route.ts)
   - ìƒíƒœ ë™ê¸°í™”

2. ë³€ê²½ íƒ€ì…ë³„ ì²˜ë¦¬ ë¡œì§
   ```typescript
   // ìŒëŸ‰ ë³€ê²½: ì¦‰ê° ë°˜ì˜ (home ìƒíƒœ ì—…ë°ì´íŠ¸)
   // ë¹›/ì»¬ëŸ¬ ë³€ê²½: route.tsë¡œ ì „ì†¡ (ë¼ì¦ˆë² ë¦¬íŒŒì´ í’€ë§)
   // í–¥ ë³€ê²½: ì¦‰ê° ë°˜ì˜ + route.ts ì „ì†¡
   ```

### Phase 3: ë¬´ë“œìŠ¤íŠ¸ë¦¼ ìë™ ìƒì„± ë¡œì§ ê°œì„ 

**ëª©í‘œ**: ë¡œê·¸ì¸ í›„ ìµœì´ˆ home ì§„ì… ì‹œ ìë™ ìƒì„± ë¡œì§ì„ ëª…í™•í•˜ê²Œ ë§Œë“¤ê¸°

**ì‘ì—…**:
1. ìë™ ìƒì„± ì¡°ê±´ í•¨ìˆ˜í™”
   ```typescript
   function shouldAutoGenerateStream(
     currentSegmentIndex: number,
     totalSegments: number
   ): boolean {
     // ë¡œê·¸ì¸ í›„ ìµœì´ˆ ì§„ì…
     // ë˜ëŠ” í˜„ì¬ ì„¸ê·¸ë¨¼íŠ¸ê°€ ë’¤ì—ì„œ 2ë²ˆì§¸ ì´ë‚´
     return currentSegmentIndex >= totalSegments - 2;
   }
   ```

2. ì´ˆê¸° ì„¸ê·¸ë¨¼íŠ¸ì™€ LLM ì„¸ê·¸ë¨¼íŠ¸ ë³‘í•© ì „ëµ ê°œì„ 
   - ë³‘í•© ë¡œì§ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
   - ë³‘í•© íƒ€ì´ë° ëª…í™•í™”

---

## ğŸ”§ êµ¬í˜„ ì˜ˆì‹œ

### useMoodStreamManager í›… êµ¬ì¡°

```typescript
export function useMoodStreamManager() {
  const [segments, setSegments] = useState<MoodStreamSegment[]>([]);
  const [currentSegmentIndex, setCurrentSegmentIndex] = useState(0);
  const [isGenerating, setIsGenerating] = useState(false);

  // ì´ˆê¸° ì„¸ê·¸ë¨¼íŠ¸ ë¡œë“œ
  const loadInitialSegments = useCallback(async () => {
    const initial = await getInitialColdStartSegments();
    setSegments(initial);
  }, []);

  // LLM ì„¸ê·¸ë¨¼íŠ¸ ìƒì„± ë° ë³‘í•©
  const generateAndMergeStream = useCallback(async () => {
    setIsGenerating(true);
    try {
      const response = await fetch('/api/moods/current/generate', {
        method: 'POST',
        body: JSON.stringify({ segmentCount: 7 })
      });
      const { moodStream } = await response.json();
      
      // ë³‘í•©: ì´ˆê¸° 3ê°œ + LLM 4ê°œ (ë§ˆì§€ë§‰ 3ê°œ ë²„ë¦¼)
      setSegments(prev => {
        const merged = [...prev, ...moodStream.slice(0, 4)];
        return merged;
      });
    } finally {
      setIsGenerating(false);
    }
  }, []);

  // ë‹¤ìŒ ìŠ¤íŠ¸ë¦¼ ìƒì„± ì¡°ê±´ ì²´í¬
  const checkAndGenerateNextStream = useCallback(() => {
    if (isGenerating) return;
    if (currentSegmentIndex >= segments.length - 2) {
      generateAndMergeStream();
    }
  }, [currentSegmentIndex, segments.length, isGenerating, generateAndMergeStream]);

  return {
    segments,
    currentSegmentIndex,
    isGenerating,
    loadInitialSegments,
    generateAndMergeStream,
    checkAndGenerateNextStream,
  };
}
```

---

## ğŸ“Š ì˜ˆìƒ íš¨ê³¼

### ì½”ë“œ ë³µì¡ë„ ê°ì†Œ
- `home/page.tsx`ì˜ ì½”ë“œ ë¼ì¸ ìˆ˜: ì•½ 700ì¤„ â†’ ì•½ 300ì¤„ (ì˜ˆìƒ)
- ìƒíƒœ ê´€ë¦¬ ë¡œì§ ë¶„ë¦¬ë¡œ ê°€ë…ì„± í–¥ìƒ
- ë²„ê·¸ ìˆ˜ì •ìœ¼ë¡œ ì¸í•œ ì¤‘ì²© ì¡°ê±´ë¬¸ ì œê±°

### ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ
- ê° í›…ì˜ ì±…ì„ ëª…í™•í™”
- í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ ë‹¨ìœ„ë¡œ ë¶„ë¦¬
- ë²„ê·¸ ë°œìƒ ì‹œ ì›ì¸ íŒŒì•… ìš©ì´

### ì„±ëŠ¥ ê°œì„ 
- ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ë°©ì§€
- ìƒíƒœ ì—…ë°ì´íŠ¸ ìµœì í™”

---

**ì‘ì„±ì¼**: 2025-01-XX  
**ì‘ì—…ì**: AI Assistant

